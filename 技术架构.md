# Latexia — 技术设计文档（TDD）

> **版本**：v1.0.0 · **状态**：Draft · **日期**：2026-02
>  **项目类型**：开源 · 在线 LaTeX 学习与练习平台
>  **定位**：面向学生、学术研究者和技术写作者的企业级 SaaS 风格 LaTeX 训练平台

------

## 目录

1. [技术栈选型](https://claude.ai/chat/c9d3dac4-95c2-409b-a8d2-a0cc71946f73#一技术栈选型)
2. [数据库设计](https://claude.ai/chat/c9d3dac4-95c2-409b-a8d2-a0cc71946f73#二数据库设计)
3. [项目目录结构](https://claude.ai/chat/c9d3dac4-95c2-409b-a8d2-a0cc71946f73#三项目目录结构)

------

## 一、技术栈选型

### 1.1 前端框架

**选型：React 18 + Next.js 14 (App Router) + TypeScript 5**

Next.js App Router 提供原生的服务端组件（RSC）、流式渲染（Streaming）、嵌套布局与路由分组，完美支持 LaTeX 教学页、题库详情页的 SEO 需求，同时支持 ISR（增量静态再生成）缓存排行榜数据。TypeScript 强类型贯穿前后端，降低运行时错误率。React 18 并发模式配合 Suspense 可实现流畅的骨架屏加载体验。

### 1.2 前端状态管理

**选型：Zustand 4 + TanStack Query v5（React Query）**

- **Zustand**：管理全局轻量 UI 状态（主题、语言、用户 Session、侧边栏展开状态），API 简洁，无 boilerplate，天然支持 TypeScript 泛型推断。
- **TanStack Query**：管理所有服务端异步状态（题目列表、排行榜、用户信息），提供缓存、后台刷新、乐观更新、分页与无限滚动，替代 Redux Thunk/Saga 的数据层职责。
- 两者职责清晰分离，不互相越界。

### 1.3 前端路由方案

**选型：Next.js App Router（基于文件系统的服务端路由）**

路由分组规划如下：

```
/                       → 首页
/(auth)/login           → 登录
/(auth)/register        → 注册
/(main)/practice        → 题库练习
/(main)/learn           → LaTeX 教学
/(main)/symbols         → 公式符号查询
/(main)/leaderboard     → 排行榜
/(main)/contest         → 比赛模式
/(main)/profile         → 个人中心
/(main)/bookmarks       → 收藏夹
/(main)/review          → 错题复习
/(main)/tools           → 工具推荐
/about                  → 关于页
/admin/(dashboard)      → 管理后台（独立 Layout）
```

### 1.4 UI 组件库

**选型：shadcn/ui（基于 Radix UI + Tailwind CSS）**

shadcn/ui 并非传统组件库，而是将组件源码复制到项目内，完全可定制，无黑盒依赖。Radix UI 的无障碍原语（Accessibility Primitives）保证 ARIA 合规。其视觉风格（高对比度、极简边框、细粒度圆角）与 Linear / Vercel / Notion 的设计语言高度一致，原生支持深色模式 Token。

辅助组件库：

- **Lucide React**：图标系统（与 shadcn/ui 官方配套）
- **Recharts**：后台数据统计图表
- **@uiw/react-codemirror**：LaTeX 代码输入编辑器（支持语法高亮）

### 1.5 CSS 方案

**选型：Tailwind CSS v3 + CSS Variables Design Token**

**设计规范：**

| 维度          | 规范                                                         |
| ------------- | ------------------------------------------------------------ |
| 主色（Brand） | `--color-primary: #6366F1`（Indigo-500，参考 Linear）        |
| 成功色        | `--color-success: #22C55E`                                   |
| 危险色        | `--color-danger: #EF4444`                                    |
| 警告色        | `--color-warning: #F59E0B`                                   |
| 浅色背景      | `#FFFFFF` / `#F8FAFC`                                        |
| 深色背景      | `#0A0A0B` / `#111113`                                        |
| 浅色文字      | `#0F172A` / `#64748B`                                        |
| 深色文字      | `#F8FAFC` / `#94A3B8`                                        |
| 圆角          | 卡片 `rounded-xl`（12px），按钮 `rounded-lg`（8px），输入框 `rounded-md`（6px） |
| 阴影          | 卡片 `shadow-sm`，弹出层 `shadow-xl`，无过度装饰             |
| 字体          | `Inter`（界面文字），`JetBrains Mono`（代码/LaTeX）          |
| 间距          | 基于 4px 网格，组件内边距以 `p-4`（16px）为标准单位          |

深色模式通过 `class="dark"` 切换（Next-themes 管理），Design Token 全部定义为 CSS Variables，Tailwind 通过 `tailwind.config.ts` 映射。

### 1.6 LaTeX 渲染库

**选型：KaTeX 0.16（客户端渲染）+ react-katex**

KaTeX 相比 MathJax 渲染速度快 5–10 倍，打包体积更小，服务端渲染友好（支持 SSR）。对于复杂公式的完整性，KaTeX 支持覆盖率已超过 95% 的常用 LaTeX 命令，满足本项目所有场景。实时预览采用 `useDebounce` + KaTeX `renderToString` 在 Web Worker 中计算，避免阻塞主线程。

### 1.7 后端框架

**选型：Hono 4（运行于 Node.js / Bun）+ TypeScript**

Hono 是类型安全的轻量级 Web 框架，原生支持 Bun / Node.js / Cloudflare Workers 多运行时，路由性能极高（基于 Radix Tree）。其中间件体系（CORS、JWT、限流、日志）开箱即用。配合 `@hono/zod-validator` 实现请求/响应 Schema 验证，形成端到端的类型安全。

微服务拆分（初期单体，预留拆分接口）：

- `api-gateway`：统一入口、鉴权中间件、限流
- `user-service`：认证、用户信息、Session 管理
- `problem-service`：题库 CRUD、练习记录
- `contest-service`：比赛创建与实时结算
- `notification-service`：邮件 / 短信 / 推送

### 1.8 ORM / 数据访问层

**选型：Drizzle ORM + PostgreSQL**

Drizzle ORM 是当前 TypeScript 生态中类型推断最精确的 ORM，Schema 即类型定义，无需手动同步，查询 API 接近原生 SQL，性能接近 `pg` 直连。迁移系统（`drizzle-kit`）支持 SQL 迁移文件版本管理，适合团队协作。

### 1.9 认证方案

**选型：自实现 JWT 双 Token + OAuth 2.0（via oslo / arctic）**

- **Access Token**：有效期 15 分钟，存储于内存（React State / Zustand）
- **Refresh Token**：有效期 30 天，存储于 `HttpOnly Secure SameSite=Strict Cookie`，防 XSS
- **Token 轮换**：每次刷新发放新 Refresh Token，旧 Token 加入 Redis 黑名单
- **OAuth 提供商**：GitHub、Google、Apple（通过 `arctic` 库，类型安全的 OAuth 2.0 / OIDC 客户端）
- **短信验证码**：对接阿里云 SMS / Twilio，验证码存 Redis，TTL 5 分钟，限流 1 分钟/次
- **设备管理**：登录时记录 `user_agent`、IP、设备指纹，存入 `user_sessions` 表，支持主动撤销

### 1.10 实时通信方案

**选型：Socket.IO 4（WebSocket + HTTP Long-polling 降级）**

排行榜增量推送、比赛倒计时同步、比赛答题状态广播均通过 Socket.IO 实现。使用 **Redis Adapter** (`@socket.io/redis-adapter`) 支持多实例水平扩展。比赛房间使用 `room` 概念隔离，倒计时由服务端权威计时（`BullMQ` 延时任务驱动），客户端仅做展示同步。

### 1.11 任务调度

**选型：BullMQ + Redis**

BullMQ 基于 Redis 的生产级队列，支持延时任务、重试、优先级、Cron 表达式。

使用场景：

- **艾宾浩斯复习计划**：答错题后向队列写入延时任务（1/2/4/7/15/30 天），到期时推送复习通知
- **每日精选题推送**：每天 08:00 通过 Cron Job 触发，向所有活跃用户发送推送
- **比赛结束结算**：比赛开始时写入延时任务，到期自动触发成绩计算与排名生成

### 1.12 文件存储

**选型：MinIO（自托管 S3 兼容）/ 生产环境可替换为阿里云 OSS / AWS S3**

头像上传流程：客户端请求服务端生成 Presigned URL → 客户端直传 MinIO → 服务端校验并更新数据库。文件访问通过 CDN（Cloudflare / 阿里云 CDN）加速，避免直接暴露 MinIO 端口。图片处理（压缩、裁剪）使用 `sharp` 在服务端完成。

### 1.13 缓存中间件

**选型：Redis 7（via ioredis）**

缓存层职责：

| 用途                | Key 模式                      | TTL                   |
| ------------------- | ----------------------------- | --------------------- |
| Access Token 黑名单 | `blacklist:token:{jti}`       | 与 Token 剩余时效一致 |
| 排行榜快照          | `leaderboard:{type}:{period}` | 5 分钟                |
| 每日题目            | `daily:problem:{date}`        | 24 小时               |
| 短信验证码          | `sms:code:{phone}`            | 5 分钟                |
| 用户信息缓存        | `user:{id}:profile`           | 10 分钟               |
| 比赛实时状态        | `contest:{id}:state`          | 比赛时长 + 1 小时     |

### 1.14 消息队列

**选型：BullMQ（复用 Redis，无需独立 MQ 服务）**

初期阶段 BullMQ 已满足所有异步任务需求。若后期并发量显著增长（DAU > 10 万），可引入 **RabbitMQ** 或 **Apache Kafka** 处理通知、日志等高吞吐场景，现有 BullMQ 调用层可通过适配器模式无缝替换。

### 1.15 数据库选型

| 层次             | 选型                      | 职责                                          |
| ---------------- | ------------------------- | --------------------------------------------- |
| 主库             | PostgreSQL 16             | 所有持久化业务数据                            |
| 缓存层           | Redis 7                   | 热点数据缓存、Session、队列、实时状态         |
| 全文检索（可选） | PostgreSQL `pg_trgm` 扩展 | 题目标题/标签模糊搜索，避免引入 Elasticsearch |

PostgreSQL 选型理由：强 ACID 事务保证练习记录一致性；JSONB 字段灵活存储题目选项、系统配置；成熟的窗口函数支持排行榜排名计算；`pg_trgm` 可实现轻量级全文检索。

### 1.16 部署方案

**开发/小规模生产：Docker Compose**
 **大规模生产：Kubernetes（K8s）**

**Docker Compose 服务组成：**

```yaml
services:
  web:        # Next.js 前端 (Node.js 20)
  api:        # Hono 后端 API
  worker:     # BullMQ Worker（任务调度）
  postgres:   # PostgreSQL 16
  redis:      # Redis 7
  minio:      # MinIO 文件存储
  nginx:      # 反向代理 + SSL 终止
```

**CI/CD：**

- **代码仓库**：GitHub
- **CI**：GitHub Actions（代码提交触发：Lint → Type Check → Unit Test → Build → Docker Build → Push to GHCR）
- **CD**：GitHub Actions + `docker compose pull && docker compose up -d`（小规模）/ ArgoCD（K8s）
- **镜像仓库**：GitHub Container Registry（GHCR）
- **环境**：`development` / `staging` / `production` 三环境隔离，通过 GitHub Environments + Secrets 管理

### 1.17 监控与日志

| 工具              | 职责                                          |
| ----------------- | --------------------------------------------- |
| **Pino**          | 后端结构化日志（JSON 格式，替代 console.log） |
| **OpenTelemetry** | 分布式链路追踪（Trace ID 贯穿请求链）         |
| **Prometheus**    | 指标采集（API 延迟、错误率、队列积压）        |
| **Grafana**       | 指标可视化仪表盘                              |
| **Sentry**        | 前后端错误监控与告警（Source Map 上传）       |
| **Uptime Kuma**   | 服务可用性监控（自托管，替代 Pingdom）        |

------

## 二、数据库设计

### 2.1 数据库类型说明

主库选用 **PostgreSQL 16**，理由：强事务一致性（练习记录、排行榜快照不容数据丢失）、丰富的窗口函数（`RANK() OVER`）原生支持排行榜计算、JSONB 灵活存储题目选项与系统配置、成熟的行级安全（RLS）可配合 RBAC 实现数据隔离。

------

### 2.2 表结构定义

#### 2.2.1 用户表 `users`

| 字段名          | 类型           | 约束                          | 说明                             |
| --------------- | -------------- | ----------------------------- | -------------------------------- |
| `id`            | `UUID`         | PK, DEFAULT gen_random_uuid() | 用户主键                         |
| `username`      | `VARCHAR(50)`  | UNIQUE, NOT NULL              | 用户名/昵称                      |
| `email`         | `VARCHAR(255)` | UNIQUE                        | 邮箱（OAuth 用户可为空）         |
| `phone`         | `VARCHAR(20)`  | UNIQUE                        | 手机号                           |
| `password_hash` | `VARCHAR(255)` |                               | bcrypt 哈希（OAuth 用户为空）    |
| `avatar_url`    | `TEXT`         |                               | 头像 URL                         |
| `bio`           | `TEXT`         |                               | 个人简介                         |
| `role`          | `VARCHAR(20)`  | NOT NULL, DEFAULT 'user'      | 角色：user / admin / super_admin |
| `status`        | `VARCHAR(20)`  | NOT NULL, DEFAULT 'active'    | active / banned / deleted        |
| `github_id`     | `VARCHAR(50)`  | UNIQUE                        | GitHub OAuth ID                  |
| `google_id`     | `VARCHAR(50)`  | UNIQUE                        | Google OAuth ID                  |
| `apple_id`      | `VARCHAR(255)` | UNIQUE                        | Apple Sign In ID                 |
| `locale`        | `VARCHAR(10)`  | DEFAULT 'zh-CN'               | 语言偏好                         |
| `theme`         | `VARCHAR(10)`  | DEFAULT 'system'              | 主题：light / dark / system      |
| `created_at`    | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()       | 注册时间                         |
| `updated_at`    | `TIMESTAMPTZ`  | NOT NULL, DEFAULT NOW()       | 更新时间                         |
| `last_login_at` | `TIMESTAMPTZ`  |                               | 最后登录时间                     |

------

#### 2.2.2 用户会话表 `user_sessions`

| 字段名               | 类型           | 约束                    | 说明                            |
| -------------------- | -------------- | ----------------------- | ------------------------------- |
| `id`                 | `UUID`         | PK                      | 会话 ID（即 Refresh Token JTI） |
| `user_id`            | `UUID`         | FK → users.id, NOT NULL | 所属用户                        |
| `refresh_token_hash` | `VARCHAR(255)` | NOT NULL                | Refresh Token 哈希              |
| `user_agent`         | `TEXT`         |                         | 设备 UA                         |
| `ip_address`         | `INET`         |                         | 登录 IP                         |
| `device_name`        | `VARCHAR(100)` |                         | 设备名称（前端推断）            |
| `is_revoked`         | `BOOLEAN`      | DEFAULT false           | 是否已撤销                      |
| `expires_at`         | `TIMESTAMPTZ`  | NOT NULL                | 过期时间                        |
| `created_at`         | `TIMESTAMPTZ`  | DEFAULT NOW()           | 创建时间                        |

------

#### 2.2.3 题目分类表 `problem_categories`

| 字段名       | 类型           | 约束                       | 说明                             |
| ------------ | -------------- | -------------------------- | -------------------------------- |
| `id`         | `SERIAL`       | PK                         | 分类 ID                          |
| `name`       | `VARCHAR(100)` | NOT NULL                   | 分类名（如：数学公式、文本排版） |
| `name_en`    | `VARCHAR(100)` |                            | 英文名                           |
| `slug`       | `VARCHAR(100)` | UNIQUE, NOT NULL           | URL 友好标识                     |
| `parent_id`  | `INTEGER`      | FK → problem_categories.id | 父分类（支持二级分类）           |
| `icon`       | `VARCHAR(50)`  |                            | 图标名                           |
| `sort_order` | `INTEGER`      | DEFAULT 0                  | 排序权重                         |
| `created_at` | `TIMESTAMPTZ`  | DEFAULT NOW()              |                                  |

------

#### 2.2.4 题目标签表 `tags`

| 字段名  | 类型          | 约束             | 说明                               |
| ------- | ------------- | ---------------- | ---------------------------------- |
| `id`    | `SERIAL`      | PK               | 标签 ID                            |
| `name`  | `VARCHAR(50)` | UNIQUE, NOT NULL | 标签名（如：矩阵、积分、希腊字母） |
| `color` | `VARCHAR(7)`  |                  | 标签颜色（十六进制）               |

------

#### 2.2.5 题目表 `problems`

| 字段名               | 类型           | 约束                       | 说明                                                   |
| -------------------- | -------------- | -------------------------- | ------------------------------------------------------ |
| `id`                 | `UUID`         | PK                         | 题目 ID                                                |
| `title`              | `VARCHAR(500)` | NOT NULL                   | 题目标题                                               |
| `content`            | `TEXT`         | NOT NULL                   | 题目内容（支持 Markdown + LaTeX）                      |
| `type`               | `VARCHAR(20)`  | NOT NULL                   | fill_blank / single / multiple / latex_input           |
| `difficulty`         | `VARCHAR(10)`  | NOT NULL                   | easy / medium / hard / hell                            |
| `category_id`        | `INTEGER`      | FK → problem_categories.id | 分类                                                   |
| `options`            | `JSONB`        |                            | 选项数组（选择题使用），`[{key, content, is_correct}]` |
| `answer`             | `TEXT`         | NOT NULL                   | 标准答案（填空/LaTeX 输入题）                          |
| `answer_explanation` | `TEXT`         |                            | 解析说明                                               |
| `preview_image_url`  | `TEXT`         |                            | 题目预览图                                             |
| `score`              | `INTEGER`      | DEFAULT 10                 | 题目分值                                               |
| `status`             | `VARCHAR(20)`  | DEFAULT 'published'        | draft / published / archived                           |
| `author_id`          | `UUID`         | FK → users.id              | 出题人                                                 |
| `attempt_count`      | `INTEGER`      | DEFAULT 0                  | 被作答次数                                             |
| `correct_count`      | `INTEGER`      | DEFAULT 0                  | 正确次数                                               |
| `created_at`         | `TIMESTAMPTZ`  | DEFAULT NOW()              |                                                        |
| `updated_at`         | `TIMESTAMPTZ`  | DEFAULT NOW()              |                                                        |

------

#### 2.2.6 题目标签关联表 `problem_tags`

| 字段名       | 类型      | 约束             | 说明 |
| ------------ | --------- | ---------------- | ---- |
| `problem_id` | `UUID`    | FK → problems.id | 题目 |
| `tag_id`     | `INTEGER` | FK → tags.id     | 标签 |

**联合主键：`(problem_id, tag_id)`**

------

#### 2.2.7 用户练习记录表 `practice_records`

| 字段名             | 类型          | 约束                       | 说明                                      |
| ------------------ | ------------- | -------------------------- | ----------------------------------------- |
| `id`               | `UUID`        | PK                         | 记录 ID                                   |
| `user_id`          | `UUID`        | FK → users.id, NOT NULL    | 用户                                      |
| `problem_id`       | `UUID`        | FK → problems.id, NOT NULL | 题目                                      |
| `submitted_answer` | `TEXT`        |                            | 用户提交的答案                            |
| `is_correct`       | `BOOLEAN`     | NOT NULL                   | 是否正确                                  |
| `time_spent_ms`    | `INTEGER`     |                            | 答题耗时（毫秒）                          |
| `source`           | `VARCHAR(20)` | DEFAULT 'practice'         | 来源：practice / contest / review / daily |
| `contest_id`       | `UUID`        | FK → contests.id           | 关联比赛（若来源为 contest）              |
| `created_at`       | `TIMESTAMPTZ` | DEFAULT NOW()              | 作答时间                                  |

**索引：`(user_id, created_at DESC)`，`(user_id, problem_id)`**

------

#### 2.2.8 收藏夹表 `bookmark_folders`

| 字段名       | 类型           | 约束                    | 说明           |
| ------------ | -------------- | ----------------------- | -------------- |
| `id`         | `UUID`         | PK                      | 收藏夹 ID      |
| `user_id`    | `UUID`         | FK → users.id, NOT NULL | 所属用户       |
| `name`       | `VARCHAR(100)` | NOT NULL                | 收藏夹名称     |
| `is_default` | `BOOLEAN`      | DEFAULT false           | 是否默认收藏夹 |
| `created_at` | `TIMESTAMPTZ`  | DEFAULT NOW()           |                |

------

#### 2.2.9 收藏记录表 `bookmarks`

| 字段名       | 类型          | 约束                       | 说明                     |
| ------------ | ------------- | -------------------------- | ------------------------ |
| `id`         | `UUID`        | PK                         | 收藏记录 ID              |
| `user_id`    | `UUID`        | FK → users.id, NOT NULL    | 用户                     |
| `problem_id` | `UUID`        | FK → problems.id, NOT NULL | 题目                     |
| `folder_id`  | `UUID`        | FK → bookmark_folders.id   | 收藏夹（可为空表示默认） |
| `created_at` | `TIMESTAMPTZ` | DEFAULT NOW()              |                          |

**唯一约束：`(user_id, problem_id)`**

------

#### 2.2.10 错题复习计划表 `review_plans`

| 字段名             | 类型          | 约束                       | 说明                                      |
| ------------------ | ------------- | -------------------------- | ----------------------------------------- |
| `id`               | `UUID`        | PK                         | 计划 ID                                   |
| `user_id`          | `UUID`        | FK → users.id, NOT NULL    | 用户                                      |
| `problem_id`       | `UUID`        | FK → problems.id, NOT NULL | 错题                                      |
| `stage`            | `INTEGER`     | DEFAULT 1                  | 当前复习阶段（1–6 对应 1/2/4/7/15/30 天） |
| `next_review_at`   | `TIMESTAMPTZ` | NOT NULL                   | 下次复习时间                              |
| `last_reviewed_at` | `TIMESTAMPTZ` |                            | 上次复习时间                              |
| `is_completed`     | `BOOLEAN`     | DEFAULT false              | 是否完成全部复习周期                      |
| `created_at`       | `TIMESTAMPTZ` | DEFAULT NOW()              |                                           |

**唯一约束：`(user_id, problem_id)`（每道错题只有一个复习计划）**
 **索引：`(user_id, next_review_at)` WHERE `is_completed = false`**

------

#### 2.2.11 每日精选题表 `daily_problems`

| 字段名       | 类型     | 约束                       | 说明                             |
| ------------ | -------- | -------------------------- | -------------------------------- |
| `id`         | `SERIAL` | PK                         |                                  |
| `problem_id` | `UUID`   | FK → problems.id, NOT NULL | 每日题目                         |
| `date`       | `DATE`   | UNIQUE, NOT NULL           | 日期                             |
| `created_by` | `UUID`   | FK → users.id              | 管理员指定（可为空表示自动选取） |

------

#### 2.2.12 排行榜快照表 `leaderboard_snapshots`

| 字段名          | 类型           | 约束                    | 说明                                  |
| --------------- | -------------- | ----------------------- | ------------------------------------- |
| `id`            | `UUID`         | PK                      |                                       |
| `user_id`       | `UUID`         | FK → users.id, NOT NULL | 用户                                  |
| `period_type`   | `VARCHAR(10)`  | NOT NULL                | daily / weekly / monthly / all_time   |
| `period_key`    | `VARCHAR(20)`  | NOT NULL                | 如：`2025-01`（月）, `2025-W03`（周） |
| `score`         | `INTEGER`      | DEFAULT 0               | 总得分                                |
| `correct_count` | `INTEGER`      | DEFAULT 0               | 正确题数                              |
| `attempt_count` | `INTEGER`      | DEFAULT 0               | 作答题数                              |
| `accuracy_rate` | `NUMERIC(5,2)` |                         | 正确率（百分比）                      |
| `rank`          | `INTEGER`      |                         | 快照排名                              |
| `updated_at`    | `TIMESTAMPTZ`  | DEFAULT NOW()           |                                       |

**唯一约束：`(user_id, period_type, period_key)`**
 **索引：`(period_type, period_key, score DESC)` 用于排行榜查询**

------

#### 2.2.13 比赛表 `contests`

| 字段名             | 类型           | 约束               | 说明                          |
| ------------------ | -------------- | ------------------ | ----------------------------- |
| `id`               | `UUID`         | PK                 | 比赛 ID                       |
| `title`            | `VARCHAR(200)` | NOT NULL           | 比赛标题                      |
| `description`      | `TEXT`         |                    | 比赛描述                      |
| `status`           | `VARCHAR(20)`  | DEFAULT 'upcoming' | upcoming / ongoing / ended    |
| `start_at`         | `TIMESTAMPTZ`  | NOT NULL           | 开始时间                      |
| `end_at`           | `TIMESTAMPTZ`  | NOT NULL           | 结束时间                      |
| `duration_minutes` | `INTEGER`      | NOT NULL           | 比赛时长（分钟）              |
| `max_participants` | `INTEGER`      |                    | 最大参与人数（NULL 表示不限） |
| `problem_ids`      | `UUID[]`       | NOT NULL           | 题目 ID 数组（有序）          |
| `created_by`       | `UUID`         | FK → users.id      | 创建者                        |
| `created_at`       | `TIMESTAMPTZ`  | DEFAULT NOW()      |                               |

------

#### 2.2.14 比赛参与记录表 `contest_participants`

| 字段名          | 类型          | 约束                       | 说明                           |
| --------------- | ------------- | -------------------------- | ------------------------------ |
| `id`            | `UUID`        | PK                         |                                |
| `contest_id`    | `UUID`        | FK → contests.id, NOT NULL | 比赛                           |
| `user_id`       | `UUID`        | FK → users.id, NOT NULL    | 用户                           |
| `score`         | `INTEGER`     | DEFAULT 0                  | 得分                           |
| `correct_count` | `INTEGER`     | DEFAULT 0                  | 正确题数                       |
| `rank`          | `INTEGER`     |                            | 最终排名                       |
| `submitted_at`  | `TIMESTAMPTZ` |                            | 提交时间（比赛结束或提前完成） |
| `joined_at`     | `TIMESTAMPTZ` | DEFAULT NOW()              | 参赛时间                       |

**唯一约束：`(contest_id, user_id)`**

------

#### 2.2.15 题目反馈表 `problem_feedbacks`

| 字段名        | 类型          | 约束                       | 说明                                        |
| ------------- | ------------- | -------------------------- | ------------------------------------------- |
| `id`          | `UUID`        | PK                         |                                             |
| `problem_id`  | `UUID`        | FK → problems.id, NOT NULL | 反馈题目                                    |
| `user_id`     | `UUID`        | FK → users.id, NOT NULL    | 反馈用户                                    |
| `error_type`  | `VARCHAR(50)` | NOT NULL                   | answer_wrong / content_error / typo / other |
| `description` | `TEXT`        | NOT NULL                   | 反馈描述                                    |
| `status`      | `VARCHAR(20)` | DEFAULT 'pending'          | pending / processing / resolved / dismissed |
| `admin_note`  | `TEXT`        |                            | 管理员备注                                  |
| `handled_by`  | `UUID`        | FK → users.id              | 处理管理员                                  |
| `created_at`  | `TIMESTAMPTZ` | DEFAULT NOW()              |                                             |
| `updated_at`  | `TIMESTAMPTZ` | DEFAULT NOW()              |                                             |

------

#### 2.2.16 LaTeX 工具推荐表 `tool_recommendations`

| 字段名        | 类型           | 约束          | 说明                             |
| ------------- | -------------- | ------------- | -------------------------------- |
| `id`          | `SERIAL`       | PK            |                                  |
| `name`        | `VARCHAR(100)` | NOT NULL      | 工具名称                         |
| `description` | `TEXT`         | NOT NULL      | 工具描述                         |
| `url`         | `TEXT`         | NOT NULL      | 工具链接                         |
| `category`    | `VARCHAR(50)`  | NOT NULL      | editor / plugin / online / other |
| `logo_url`    | `TEXT`         |               | LOGO 图片                        |
| `tags`        | `TEXT[]`       |               | 标签数组                         |
| `is_featured` | `BOOLEAN`      | DEFAULT false | 是否精选                         |
| `sort_order`  | `INTEGER`      | DEFAULT 0     | 排序                             |
| `created_by`  | `UUID`         | FK → users.id |                                  |
| `created_at`  | `TIMESTAMPTZ`  | DEFAULT NOW() |                                  |

------

#### 2.2.17 系统配置表 `system_configs`

| 字段名        | 类型           | 约束          | 说明                              |
| ------------- | -------------- | ------------- | --------------------------------- |
| `key`         | `VARCHAR(100)` | PK            | 配置键（如：`site.announcement`） |
| `value`       | `JSONB`        | NOT NULL      | 配置值（JSON 格式）               |
| `description` | `TEXT`         |               | 配置说明                          |
| `updated_by`  | `UUID`         | FK → users.id | 最后修改人                        |
| `updated_at`  | `TIMESTAMPTZ`  | DEFAULT NOW() |                                   |

------

#### 2.2.18 管理员操作日志表 `admin_audit_logs`

| 字段名        | 类型           | 约束                    | 说明                                     |
| ------------- | -------------- | ----------------------- | ---------------------------------------- |
| `id`          | `UUID`         | PK                      |                                          |
| `admin_id`    | `UUID`         | FK → users.id, NOT NULL | 操作管理员                               |
| `action`      | `VARCHAR(100)` | NOT NULL                | 操作类型（如：`problem.delete`）         |
| `target_type` | `VARCHAR(50)`  |                         | 操作目标类型（user / problem / contest） |
| `target_id`   | `TEXT`         |                         | 操作目标 ID                              |
| `diff`        | `JSONB`        |                         | 变更前后内容                             |
| `ip_address`  | `INET`         |                         | 操作 IP                                  |
| `created_at`  | `TIMESTAMPTZ`  | DEFAULT NOW()           |                                          |

------

#### 2.2.19 教学章节表 `learn_chapters`

| 字段名         | 类型           | 约束          | 说明        |
| -------------- | -------------- | ------------- | ----------- |
| `id`           | `SERIAL`       | PK            |             |
| `title`        | `VARCHAR(200)` | NOT NULL      | 章节标题    |
| `title_en`     | `VARCHAR(200)` |               | 英文标题    |
| `slug`         | `VARCHAR(100)` | UNIQUE        | URL 标识    |
| `content`      | `TEXT`         | NOT NULL      | 内容（MDX） |
| `sort_order`   | `INTEGER`      | DEFAULT 0     | 排序        |
| `is_published` | `BOOLEAN`      | DEFAULT true  | 是否发布    |
| `updated_at`   | `TIMESTAMPTZ`  | DEFAULT NOW() |             |

------

#### 2.2.20 学习进度表 `user_learn_progress`

| 字段名         | 类型          | 约束                   | 说明     |
| -------------- | ------------- | ---------------------- | -------- |
| `user_id`      | `UUID`        | FK → users.id          | 用户     |
| `chapter_id`   | `INTEGER`     | FK → learn_chapters.id | 章节     |
| `is_completed` | `BOOLEAN`     | DEFAULT false          | 是否完成 |
| `completed_at` | `TIMESTAMPTZ` |                        | 完成时间 |

**联合主键：`(user_id, chapter_id)`**

------

#### 2.2.21 LaTeX 符号库表 `latex_symbols`

| 字段名        | 类型           | 约束      | 说明                                            |
| ------------- | -------------- | --------- | ----------------------------------------------- |
| `id`          | `SERIAL`       | PK        |                                                 |
| `name`        | `VARCHAR(100)` | NOT NULL  | 符号名称（如：Alpha）                           |
| `latex_code`  | `VARCHAR(200)` | NOT NULL  | LaTeX 代码（如：`\alpha`）                      |
| `category`    | `VARCHAR(50)`  | NOT NULL  | math / greek / arrow / matrix / physics / other |
| `description` | `TEXT`         |           | 符号说明                                        |
| `example`     | `TEXT`         |           | 使用示例                                        |
| `sort_order`  | `INTEGER`      | DEFAULT 0 |                                                 |

------

### 2.3 表间关联关系说明

```
users (1) ──────────< (N) user_sessions
users (1) ──────────< (N) practice_records >──────── (N) problems
users (1) ──────────< (N) bookmark_folders
users (1) ──────────< (N) bookmarks >──────────────< (N) bookmark_folders
users (1) ──────────< (N) review_plans >───────────< (N) problems
users (1) ──────────< (N) problem_feedbacks >──────< (N) problems
users (1) ──────────< (N) leaderboard_snapshots
users (1) ──────────< (N) contest_participants >───< (N) contests
users (1) ──────────< (N) user_learn_progress >────< (N) learn_chapters

problems (N) ───────< (N) tags  [via problem_tags]
problems (N) ───────> (1) problem_categories
problems (N) ───────> (1) users  [author_id]

problem_categories (1) > (N) problem_categories [parent_id 自引用，二级分类]

contests (N) ───────< (N) users  [via contest_participants]

admin_audit_logs (N) > (1) users [admin_id]
system_configs (N)   > (1) users [updated_by]
daily_problems (N)   > (1) problems
```

------

## 三、项目目录结构

### 3.1 Monorepo 总览

```
latexia/
├── apps/
│   ├── web/                    # Next.js 前端应用
│   └── api/                    # Hono 后端 API 服务
├── packages/
│   ├── ui/                     # 共享 UI 组件（基于 shadcn/ui）
│   ├── types/                  # 共享 TypeScript 类型定义
│   ├── validators/             # 共享 Zod Schema（前后端复用）
│   └── config/                 # 共享配置（ESLint、TypeScript 等）
├── infra/
│   ├── docker/                 # Dockerfile 集合
│   ├── docker-compose.yml      # 开发环境编排
│   ├── docker-compose.prod.yml # 生产环境编排
│   └── nginx/                  # Nginx 配置
├── .github/
│   └── workflows/              # CI/CD GitHub Actions
├── docs/                       # 项目文档
├── scripts/                    # 数据库种子、工具脚本
├── package.json                # Monorepo 根配置（pnpm workspaces）
├── pnpm-workspace.yaml
├── turbo.json                  # Turborepo 构建缓存配置
└── README.md
```

------

### 3.2 前端目录（`apps/web/`）

```
apps/web/
├── src/
│   ├── app/                            # Next.js App Router
│   │   ├── (auth)/                     # 认证路由组（独立 Layout，无导航栏）
│   │   │   ├── login/
│   │   │   │   └── page.tsx
│   │   │   ├── register/
│   │   │   │   └── page.tsx
│   │   │   ├── forgot-password/
│   │   │   │   └── page.tsx
│   │   │   └── layout.tsx              # 认证页公共 Layout
│   │   │
│   │   ├── (main)/                     # 主应用路由组（带导航栏、侧边栏）
│   │   │   ├── layout.tsx              # 主 Layout（Header + Sidebar + Footer）
│   │   │   ├── practice/
│   │   │   │   ├── page.tsx            # 题库列表页
│   │   │   │   └── [id]/
│   │   │   │       └── page.tsx        # 题目详情/答题页
│   │   │   ├── learn/
│   │   │   │   ├── page.tsx            # 教学首页（章节列表）
│   │   │   │   └── [slug]/
│   │   │   │       └── page.tsx        # 章节内容页
│   │   │   ├── symbols/
│   │   │   │   └── page.tsx            # LaTeX 符号查询页
│   │   │   ├── leaderboard/
│   │   │   │   └── page.tsx            # 排行榜页
│   │   │   ├── contest/
│   │   │   │   ├── page.tsx            # 比赛列表页
│   │   │   │   ├── [id]/
│   │   │   │   │   ├── page.tsx        # 比赛详情/等待室
│   │   │   │   │   └── arena/
│   │   │   │   │       └── page.tsx    # 实时答题竞技场
│   │   │   │   └── history/
│   │   │   │       └── page.tsx        # 历史比赛记录
│   │   │   ├── profile/
│   │   │   │   ├── page.tsx            # 个人中心
│   │   │   │   └── settings/
│   │   │   │       └── page.tsx        # 账号设置
│   │   │   ├── bookmarks/
│   │   │   │   └── page.tsx            # 收藏夹管理页
│   │   │   ├── review/
│   │   │   │   └── page.tsx            # 错题复习页
│   │   │   └── tools/
│   │   │       └── page.tsx            # LaTeX 工具推荐页
│   │   │
│   │   ├── admin/                      # 管理后台路由组（独立 Layout + RBAC 守卫）
│   │   │   ├── layout.tsx              # 后台 Layout
│   │   │   ├── page.tsx                # 后台首页（数据仪表盘）
│   │   │   ├── problems/
│   │   │   │   ├── page.tsx            # 题目管理列表
│   │   │   │   ├── create/
│   │   │   │   │   └── page.tsx
│   │   │   │   └── [id]/edit/
│   │   │   │       └── page.tsx
│   │   │   ├── users/
│   │   │   │   └── page.tsx            # 用户管理
│   │   │   ├── feedbacks/
│   │   │   │   └── page.tsx            # 反馈处理
│   │   │   ├── contests/
│   │   │   │   └── page.tsx            # 比赛管理
│   │   │   └── settings/
│   │   │       └── page.tsx            # 系统配置
│   │   │
│   │   ├── about/
│   │   │   └── page.tsx                # 关于页
│   │   ├── layout.tsx                  # 根 Layout（主题 Provider、I18n Provider）
│   │   ├── page.tsx                    # 首页（Landing Page）
│   │   ├── not-found.tsx
│   │   └── error.tsx
│   │
│   ├── components/                     # 项目级共享组件
│   │   ├── layout/
│   │   │   ├── Header.tsx
│   │   │   ├── Sidebar.tsx
│   │   │   └── Footer.tsx
│   │   ├── problem/
│   │   │   ├── ProblemCard.tsx
│   │   │   ├── ProblemFilter.tsx
│   │   │   ├── AnswerInput.tsx         # LaTeX 代码输入框（含实时预览）
│   │   │   └── LatexPreview.tsx        # KaTeX 渲染组件
│   │   ├── contest/
│   │   │   ├── ContestTimer.tsx
│   │   │   └── ContestRankTable.tsx
│   │   ├── leaderboard/
│   │   │   └── RankTable.tsx
│   │   └── common/
│   │       ├── ThemeSwitcher.tsx
│   │       ├── LocaleSwitcher.tsx
│   │       ├── AvatarUpload.tsx
│   │       └── MarkdownRenderer.tsx
│   │
│   ├── hooks/                          # 自定义 React Hooks
│   │   ├── useAuth.ts                  # 认证状态与操作
│   │   ├── useDebounce.ts
│   │   ├── useLeaderboard.ts
│   │   ├── useContest.ts               # WebSocket 连接管理
│   │   └── useReviewPlan.ts
│   │
│   ├── store/                          # Zustand 状态仓库
│   │   ├── auth.store.ts               # 用户认证 & Session 状态
│   │   ├── ui.store.ts                 # 主题、语言、侧边栏等 UI 状态
│   │   └── contest.store.ts            # 比赛实时状态（倒计时、答题进度）
│   │
│   ├── lib/                            # 工具函数与第三方初始化
│   │   ├── api-client.ts               # 封装 fetch（自动刷新 Token、拦截器）
│   │   ├── katex.ts                    # KaTeX 渲染工具函数
│   │   ├── socket.ts                   # Socket.IO 客户端单例
│   │   ├── i18n.ts                     # 国际化初始化
│   │   └── utils.ts                    # 通用工具函数
│   │
│   ├── i18n/                           # 国际化资源
│   │   ├── zh-CN/
│   │   │   └── common.json
│   │   ├── zh-TW/
│   │   │   └── common.json
│   │   └── en/
│   │       └── common.json
│   │
│   ├── styles/
│   │   └── globals.css                 # CSS Variables Design Tokens + Tailwind 基础样式
│   │
│   └── types/                          # 前端局部类型（补充 packages/types）
│       └── next-auth.d.ts
│
├── public/                             # 静态资源
│   ├── fonts/
│   └── images/
├── next.config.ts
├── tailwind.config.ts
├── tsconfig.json
└── package.json
```

------

### 3.3 后端目录（`apps/api/`）

```
apps/api/
├── src/
│   ├── index.ts                        # 应用入口（Hono 实例创建、全局中间件挂载）
│   │
│   ├── config/                         # 配置加载（环境变量校验、常量）
│   │   ├── env.ts                      # 使用 zod 校验 process.env
│   │   ├── database.ts                 # Drizzle ORM 连接配置
│   │   └── redis.ts                    # ioredis 连接配置
│   │
│   ├── db/                             # 数据库层
│   │   ├── schema/                     # Drizzle Schema 定义（每表一文件）
│   │   │   ├── users.ts
│   │   │   ├── problems.ts
│   │   │   ├── practice_records.ts
│   │   │   ├── bookmarks.ts
│   │   │   ├── review_plans.ts
│   │   │   ├── contests.ts
│   │   │   ├── leaderboard_snapshots.ts
│   │   │   ├── problem_feedbacks.ts
│   │   │   ├── learn.ts
│   │   │   ├── system_configs.ts
│   │   │   └── index.ts                # 统一导出
│   │   ├── migrations/                 # Drizzle Kit 生成的 SQL 迁移文件
│   │   └── seed.ts                     # 数据库种子脚本
│   │
│   ├── modules/                        # 业务模块（每模块独立路由+服务+类型）
│   │   ├── auth/
│   │   │   ├── auth.routes.ts          # POST /auth/login, /register, /refresh...
│   │   │   ├── auth.service.ts         # 业务逻辑（Token 签发、OAuth 处理）
│   │   │   ├── auth.validators.ts      # Zod 请求体 Schema
│   │   │   └── oauth/
│   │   │       ├── github.ts           # GitHub OAuth 流程
│   │   │       ├── google.ts           # Google OAuth 流程
│   │   │       └── apple.ts            # Apple Sign In 流程
│   │   │
│   │   ├── users/
│   │   │   ├── users.routes.ts         # GET/PUT /users/me, /users/:id (admin)
│   │   │   ├── users.service.ts
│   │   │   └── users.validators.ts
│   │   │
│   │   ├── problems/
│   │   │   ├── problems.routes.ts      # CRUD + 批量导入导出
│   │   │   ├── problems.service.ts
│   │   │   └── problems.validators.ts
│   │   │
│   │   ├── practice/
│   │   │   ├── practice.routes.ts      # POST /practice/submit, GET /practice/history
│   │   │   └── practice.service.ts
│   │   │
│   │   ├── bookmarks/
│   │   │   ├── bookmarks.routes.ts
│   │   │   └── bookmarks.service.ts
│   │   │
│   │   ├── review/
│   │   │   ├── review.routes.ts        # GET /review/today, POST /review/complete
│   │   │   └── review.service.ts       # 艾宾浩斯调度逻辑
│   │   │
│   │   ├── leaderboard/
│   │   │   ├── leaderboard.routes.ts
│   │   │   └── leaderboard.service.ts  # 排行榜计算与快照更新
│   │   │
│   │   ├── contests/
│   │   │   ├── contests.routes.ts
│   │   │   ├── contests.service.ts
│   │   │   └── contests.gateway.ts     # Socket.IO 事件处理（比赛实时通信）
│   │   │
│   │   ├── feedbacks/
│   │   │   ├── feedbacks.routes.ts
│   │   │   └── feedbacks.service.ts
│   │   │
│   │   ├── learn/
│   │   │   ├── learn.routes.ts
│   │   │   └── learn.service.ts
│   │   │
│   │   ├── symbols/
│   │   │   ├── symbols.routes.ts       # GET /symbols?category=&q=
│   │   │   └── symbols.service.ts
│   │   │
│   │   ├── tools/
│   │   │   ├── tools.routes.ts
│   │   │   └── tools.service.ts
│   │   │
│   │   ├── daily/
│   │   │   └── daily.service.ts        # 每日题目选取逻辑
│   │   │
│   │   └── admin/
│   │       ├── admin.routes.ts         # 后台专属路由（/admin/**）
│   │       ├── admin.service.ts
│   │       └── dashboard.service.ts    # 数据统计仪表盘聚合查询
│   │
│   ├── middleware/                     # 全局中间件
│   │   ├── auth.middleware.ts          # JWT 验证、注入 ctx.user
│   │   ├── rbac.middleware.ts          # RBAC 角色权限检查
│   │   ├── rate-limit.middleware.ts    # 基于 Redis 的限流
│   │   ├── logger.middleware.ts        # Pino 请求日志
│   │   └── error.middleware.ts         # 全局异常处理器
│   │
│   ├── jobs/                           # BullMQ 队列 Worker 与 Scheduler
│   │   ├── queues.ts                   # 队列定义（review-queue, daily-queue 等）
│   │   ├── workers/
│   │   │   ├── review.worker.ts        # 处理复习计划到期推送
│   │   │   ├── daily.worker.ts         # 每日题目推送
│   │   │   └── contest.worker.ts       # 比赛结束结算
│   │   └── schedulers/
│   │       └── daily.scheduler.ts      # Cron: 每天 08:00 触发每日推送
│   │
│   ├── socket/                         # Socket.IO 服务端
│   │   ├── socket.ts                   # Socket.IO Server 初始化（Redis Adapter 配置）
│   │   ├── namespaces/
│   │   │   ├── contest.namespace.ts    # /contest 命名空间（比赛实时通信）
│   │   │   └── leaderboard.namespace.ts # /leaderboard 命名空间（排行榜推送）
│   │   └── guards/
│   │       └── socket-auth.guard.ts    # WebSocket 连接认证
│   │
│   ├── storage/                        # 文件存储服务
│   │   └── minio.ts                    # MinIO 客户端封装（Presigned URL 生成）
│   │
│   ├── mail/                           # 邮件服务
│   │   ├── mail.service.ts             # Nodemailer/Resend 封装
│   │   └── templates/                  # 邮件 HTML 模板
│   │       ├── verify-email.html
│   │       └── reset-password.html
│   │
│   ├── sms/                            # 短信服务
│   │   └── sms.service.ts              # 阿里云 SMS / Twilio 封装
│   │
│   └── utils/                          # 通用工具
│       ├── crypto.ts                   # bcrypt、JWT 签发/验证
│       ├── pagination.ts               # 分页工具函数
│       └── ebbinghaus.ts               # 艾宾浩斯间隔计算算法
│
├── drizzle.config.ts                   # Drizzle Kit 配置
├── tsconfig.json
└── package.json
```

------

### 3.4 工程化配置目录

```
latexia/
├── infra/
│   ├── docker/
│   │   ├── Dockerfile.web              # Next.js 多阶段构建镜像
│   │   ├── Dockerfile.api              # Hono API 镜像
│   │   └── Dockerfile.worker           # BullMQ Worker 镜像
│   ├── nginx/
│   │   ├── nginx.conf                  # 反向代理配置（含 WebSocket 升级头）
│   │   └── ssl/                        # SSL 证书（.gitignore 忽略）
│   ├── docker-compose.yml              # 开发环境（含 hot-reload volume 挂载）
│   └── docker-compose.prod.yml         # 生产环境（无 volume，使用构建镜像）
│
├── .github/
│   └── workflows/
│       ├── ci.yml                      # PR 触发：Lint + Type Check + Test + Build
│       ├── cd-staging.yml              # push to `develop` 触发：部署到 Staging
│       └── cd-production.yml           # push to `main` 触发：部署到 Production
│
├── docs/
│   ├── TDD.md                          # 本技术设计文档
│   ├── API.md                          # API 接口文档（或使用 Swagger/OpenAPI）
│   ├── CONTRIBUTING.md                 # 贡献指南
│   └── CHANGELOG.md                    # 更新日志
│
└── scripts/
    ├── seed-problems.ts                # 题库种子数据导入脚本
    ├── seed-symbols.ts                 # LaTeX 符号库种子数据
    └── import-problems.ts              # 批量题目 JSON 导入工具
```

------

## 附录：关键技术决策汇总

| 决策点     | 选型结论                           | 核心理由                                  |
| ---------- | ---------------------------------- | ----------------------------------------- |
| 前端框架   | Next.js 14 + React 18              | SSR/ISR 支持 SEO，App Router 支持嵌套布局 |
| 状态管理   | Zustand + TanStack Query           | UI 状态与服务端状态分离，各司其职         |
| UI 组件库  | shadcn/ui + Radix UI               | 完全可控的源码组件，深色模式原生支持      |
| LaTeX 渲染 | KaTeX                              | 渲染速度最快，SSR 友好                    |
| 后端框架   | Hono 4                             | 类型安全，性能优越，多运行时兼容          |
| ORM        | Drizzle ORM                        | TypeScript 类型推断最精确，接近原生 SQL   |
| 认证       | 自实现 JWT 双 Token + arctic OAuth | 完全掌控 Token 策略，无第三方服务依赖锁定 |
| 实时通信   | Socket.IO 4 + Redis Adapter        | 生产级 WebSocket，支持水平扩展            |
| 任务调度   | BullMQ                             | 基于 Redis，生产级队列，复用缓存层        |
| 数据库     | PostgreSQL 16 + Redis 7            | ACID 事务 + 缓存热点数据，经典组合        |
| 文件存储   | MinIO（S3 兼容）                   | 自托管，可无缝迁移 AWS S3 / 阿里云 OSS    |
| Monorepo   | pnpm workspaces + Turborepo        | 高效依赖管理，增量构建缓存                |
| 部署       | Docker Compose → Kubernetes        | 渐进式扩展路径，CI/CD 通过 GitHub Actions |

------

*本文档由 Latexia 架构团队维护，如有变更请同步更新本文档并在 CHANGELOG.md 中记录。*